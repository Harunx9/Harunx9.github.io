
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="https://harunx9.github.io/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://harunx9.github.io/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://harunx9.github.io/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://harunx9.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Programming warfare Atom">

    <link href="https://harunx9.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Programming warfare RSS">


<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85776912-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<meta name="author" content="Szymon Wanot" />
<meta name="description" content="Cześć. Ostatnio przedstawiłem wam zamysł mojego modułowego systemu do tworzenia tooli CLI w .NET Core. To co będę prezentował w tym poście jest to implementacja POC, więc kod momentami jest robiony na szybko. Będę pisał o tym co myślę, że można jeszcze poprawić w dalszej części artykułu. Na początku zanim …" />
<meta name="keywords" content="blog, .net, programming, c#, .netcore, cli">

<meta property="og:site_name" content="Programming warfare"/>
<meta property="og:title" content="Komponentowe CLI część 2. Implementacja"/>
<meta property="og:description" content="Cześć. Ostatnio przedstawiłem wam zamysł mojego modułowego systemu do tworzenia tooli CLI w .NET Core. To co będę prezentował w tym poście jest to implementacja POC, więc kod momentami jest robiony na szybko. Będę pisał o tym co myślę, że można jeszcze poprawić w dalszej części artykułu. Na początku zanim …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://harunx9.github.io/komponentowe-cli-czesc-2-implementacja.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-09-02 16:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://harunx9.github.io/author/szymon-wanot.html">
<meta property="article:section" content=".NET"/>
<meta property="article:tag" content="blog"/>
<meta property="article:tag" content=".net"/>
<meta property="article:tag" content="programming"/>
<meta property="article:tag" content="c#"/>
<meta property="article:tag" content=".netcore"/>
<meta property="article:tag" content="cli"/>
<meta property="og:image" content="/images/avatar.jpg">

  <title>Programming warfare &ndash; Komponentowe CLI część 2. Implementacja</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://harunx9.github.io">
        <img src="/images/avatar.jpg" alt="" title="">
      </a>
      <h1><a href="https://harunx9.github.io"></a></h1>


      <nav>
        <ul class="list">
          <li><a href="https://harunx9.github.io/pages/o-mnie.html#o-mnie">O mnie</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://github.com/Harunx9" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-linkedin" href="https://pl.linkedin.com/in/szymon-wanot-b0a146ab" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/szwanot" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/szymon.wanot" target="_blank"><i class="fa fa-facebook"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="komponentowe-cli-czesc-2-implementacja">Komponentowe CLI część 2. Implementacja</h1>
    <p>
          Posted on Sat 02 September 2017 in <a href="https://harunx9.github.io/category/net.html">.NET</a>


    </p>
  </header>


  <div>
    <p>Cześć. Ostatnio przedstawiłem wam zamysł mojego modułowego systemu do tworzenia tooli CLI w .NET Core. To co będę prezentował w tym poście jest to implementacja POC, więc kod momentami jest robiony na szybko. Będę pisał o tym co myślę, że można jeszcze poprawić w dalszej części artykułu. Na początku zanim pojawi się kodzik opiszę na czym opiera się całe rozwiązanie. Aplikacje CLI postanowiłem zamodelować za pomocą handlerów. To co wpisujemy do konsoli to komenda, kolejne parametry to wartości obiektu komendy. Każda komenda ma odpowiadający jej handler, który po sparsowaniu argumentów jest tworzony z kontenera DI. Przykładowo wyglądająca komenda może mieć następującą implementacje:</p>
<div class="highlight"><pre><span></span><span class="na">[Command(&quot;help&quot;, Alias = &quot;h&quot;, HelpText = &quot;Help for cli&quot;)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">HelpCommand</span>
<span class="p">{</span>
<span class="na">    [CommandOptionsValue(&quot;command&quot;, Alias = &quot;c&quot;, HelpText = &quot;Type command name to get detailed help&quot;)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">CommandName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">ErrorMessage</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Handler można zaimplmentować w następujący sposób</p>
<div class="highlight"><pre><span></span><span class="na">[CommandHandler(&quot;help&quot;)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">HelpCommandHandler</span> <span class="p">:</span> <span class="n">ConsoleCommandHandler</span><span class="p">&lt;</span><span class="n">HelpCommand</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IHelpGenerator</span> <span class="n">_helpGenerator</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">HelpCommandHandler</span><span class="p">(</span><span class="n">IHelpGenerator</span> <span class="n">helpGenerator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_helpGenerator</span> <span class="p">=</span> <span class="n">helpGenerator</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">HelpCommand</span> <span class="n">command</span><span class="p">,</span> <span class="n">TextWriter</span> <span class="n">@out</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">StringBuilder</span> <span class="n">helpText</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">CommandName</span><span class="p">)</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">helpText</span> <span class="p">=</span> <span class="n">_helpGenerator</span><span class="p">.</span><span class="n">GenerateForCommand</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">CommandName</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">helpText</span> <span class="p">=</span> <span class="n">_helpGenerator</span><span class="p">.</span><span class="n">GenerateForProgram</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">ErrorMessage</span><span class="p">)</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">helpText</span><span class="p">.</span><span class="n">AppendLine</span><span class="p">(</span><span class="s">&quot;Error message&quot;</span><span class="p">);</span>
            <span class="n">helpText</span><span class="p">.</span><span class="n">AppendLine</span><span class="p">(</span><span class="n">command</span><span class="p">.</span><span class="n">ErrorMessage</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">@out</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">helpText</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Cała funkcja Main sprowadza się jedynie do kilku linii i generalnie wygląda tak:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">containerBuilder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ContainerBuilder</span><span class="p">();</span>
        <span class="n">containerBuilder</span>
            <span class="p">.</span><span class="n">RegisterDependencies</span><span class="p">(</span><span class="n">AssemblyFinder</span><span class="p">.</span><span class="n">GetCurrentAssemblyWithDependencies</span><span class="p">());</span>
        <span class="n">containerBuilder</span><span class="p">.</span><span class="n">RegisterConsoleCommands</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CommandLineApplication</span><span class="p">(</span>
            <span class="k">new</span> <span class="nf">AutofacCommandResolver</span><span class="p">(</span><span class="n">containerBuilder</span><span class="p">.</span><span class="n">Build</span><span class="p">()),</span> <span class="n">Console</span><span class="p">.</span><span class="n">Out</span><span class="p">);</span>

        <span class="n">app</span><span class="p">.</span><span class="n">Run</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Dodatkowo dodając kolejne komendy nic się nie zmieni poza nowymi plikami w odpowiednich libkach, więc tak na prawdę wystarczy mieć jedną aplikacje i dodać kilka dll, które będą zwierać nowe komendy i tak będziemy komponować swoje aplikacje. O tym pisałem już we wcześniejszym artykule, więc od teorii przejdźmy do implementacji. Podobnie jak w przypadku automatycznej rejestracji oparłem całe rozwiązanie o atrybuty, choć mam pewne wątpliwości, ale to później. Atrybutów jest kilka:</p>
<div class="highlight"><pre><span></span><span class="na">[System.AttributeUsage(AttributeTargets.Class, Inherited = false, AllowMultiple = true)]</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">CommandAttribute</span> <span class="p">:</span> <span class="n">Attribute</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Alias</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">HelpText</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">CommandAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="na">[System.AttributeUsage(AttributeTargets.Property, Inherited = false, AllowMultiple = true)]</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">CommandOptionsValueAttribute</span> <span class="p">:</span> <span class="n">Attribute</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Alias</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">Required</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">object</span> <span class="n">DefaultValue</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">HelpText</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">CommandOptionsValueAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="na">[AttributeUsage(AttributeTargets.Class, Inherited = false, AllowMultiple = true)]</span>
<span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">CommandHandlerAttribute</span> <span class="p">:</span> <span class="n">Attribute</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">CommandName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">CommandHandlerAttribute</span><span class="p">(</span><span class="kt">string</span> <span class="n">commandName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">CommandName</span> <span class="p">=</span> <span class="n">commandName</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Pierwszy atrybut dajemy nad klasę, która ma być komendą, a drugi nad właściwości w klasie komendy, które będą wartościami opcji komendy. CommandHandlerAttribute należy dać nad klasę, która ma być handlerem dla danej komendy. Co istotne nazwa komendy i handlera musi być taka sama, ponieważ inaczej nie zostaną one dobrze sparsowane. Muszę pomyśleć nad tym jak to inaczej zrobić, żeby ominąć ten problem, ale na razie nie wydaje mi się to wielką niedogodnością. 
Bazowa klasa handlera wygląda w następujący sposób:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">interface</span> <span class="n">IConsoleCommandHandler</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">ExecuteFromParsedArgs</span><span class="p">(</span><span class="n">CommandLineParsedArgs</span> <span class="n">args</span><span class="p">,</span> <span class="n">TextWriter</span> <span class="n">@out</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ConsoleCommandHandler</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IConsoleCommandHandler</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
<span class="p">{</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">ExecuteFromParsedArgs</span><span class="p">(</span><span class="n">CommandLineParsedArgs</span> <span class="n">args</span><span class="p">,</span> <span class="n">TextWriter</span> <span class="n">@out</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">T</span> <span class="n">command</span> <span class="p">=</span> <span class="n">CommandFactory</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">args</span><span class="p">);</span>
        <span class="n">Execute</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">@out</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">abstract</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">T</span> <span class="n">command</span><span class="p">,</span> <span class="n">TextWriter</span> <span class="n">@out</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>Dodatkowy interfejs jest nam potrzebny dla rozwiązywania zależności przez kontener DI, ale o tym później. Jak widzimy metoda ExecuteFromParsedArgs przyjmuje sparsowane argumenty. Klasa argumentów wygląda tak:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">CommandLineParsedArgs</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">CommandName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">CommandOptionsValues</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">CommandLineParsedArgs</span><span class="p">(</span><span class="kt">string</span> <span class="n">commandName</span><span class="p">,</span> 
        <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">commandOptionsValues</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">CommandName</span> <span class="p">=</span> <span class="n">commandName</span><span class="p">;</span>
        <span class="n">CommandOptionsValues</span> <span class="p">=</span> <span class="n">commandOptionsValues</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">string</span> <span class="nf">GetValueFor</span><span class="p">(</span><span class="kt">string</span> <span class="n">option</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">CommandOptionsValues</span><span class="p">[</span><span class="n">option</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Sam parser natomiast dziełem sztuki nie jest (bo powinienem to zrobić za pomocą tokenów), ale działa. Kodzik wygląda oto w taki sposób:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">CommandLineArgsParser</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_argDelimiter</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">char</span><span class="p">[]</span> <span class="n">_valueDelimiters</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">int</span> <span class="n">_commandIndexPlacement</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">CommandLineArgsParser</span><span class="p">(</span>
        <span class="kt">string</span> <span class="n">argDelimiter</span><span class="p">,</span>
        <span class="kt">char</span><span class="p">[]</span> <span class="n">valueDelimiters</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">commandIndexPlacement</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_argDelimiter</span> <span class="p">=</span> <span class="n">argDelimiter</span><span class="p">;</span>
        <span class="n">_valueDelimiters</span> <span class="p">=</span> <span class="n">valueDelimiters</span><span class="p">;</span>
        <span class="n">_commandIndexPlacement</span> <span class="p">=</span> <span class="n">commandIndexPlacement</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">CommandLineParsedArgs</span> <span class="nf">Parse</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Any</span><span class="p">()</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">EmptyArgsException</span><span class="p">();</span>

        <span class="kt">string</span> <span class="n">commandName</span> <span class="p">=</span> <span class="n">ParseCommandName</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
        <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">options</span> <span class="p">=</span> <span class="n">ParseCommandOptions</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">CommandLineParsedArgs</span><span class="p">(</span><span class="n">commandName</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">ParseCommandOptions</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">args</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Skip</span><span class="p">(</span><span class="m">1</span><span class="p">).</span><span class="n">ToArray</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;();</span>
        <span class="kt">string</span> <span class="n">curretnOption</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">currentValue</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">arg</span> <span class="k">in</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">bool</span> <span class="n">removeOption</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="kt">bool</span> <span class="n">addToDict</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">delimiter</span> <span class="p">=</span> <span class="n">_valueDelimiters</span>
                <span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">Contains</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">default</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="p">!=</span> <span class="n">delimiter</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">curretnOption</span> <span class="p">=</span> <span class="n">arg</span>
                    <span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">First</span><span class="p">()</span>
                    <span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">_argDelimiter</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

                <span class="n">currentValue</span> <span class="p">=</span> <span class="n">arg</span>
                    <span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
                    <span class="p">.</span><span class="n">Last</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">_argDelimiter</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">curretnOption</span> <span class="p">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">_argDelimiter</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
                    <span class="n">removeOption</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                    <span class="n">addToDict</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">curretnOption</span> <span class="p">!=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span> <span class="p">&amp;&amp;</span>
                    <span class="n">arg</span><span class="p">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">_argDelimiter</span><span class="p">)</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">currentValue</span> <span class="p">=</span> <span class="n">arg</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">addToDict</span><span class="p">)</span>
                <span class="n">options</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">curretnOption</span><span class="p">,</span> <span class="n">currentValue</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">removeOption</span><span class="p">)</span>
                <span class="n">curretnOption</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
            <span class="n">currentValue</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">options</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="kt">string</span> <span class="nf">ParseCommandName</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">commandName</span> <span class="p">=</span> <span class="n">args</span><span class="p">[</span><span class="n">_commandIndexPlacement</span><span class="p">];</span>

        <span class="k">return</span> <span class="n">commandName</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>W przyszłości to pewnie zmiennie, ale na razie działa, jest przetestowane, więc niech na razie takie zostanie. W handlerze jest jeszcze jeden, który zamienia argumenty na komendę, a mianowicie CommandFactory:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CommandFactory</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">T</span> <span class="n">Create</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">CommandLineParsedArgs</span> <span class="n">args</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Type</span><span class="p">[]</span> <span class="n">commands</span> <span class="p">=</span> <span class="n">FindCommand</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">commands</span><span class="p">.</span><span class="n">Count</span><span class="p">()</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">TooManyCommandsWithSameNameException</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">CommandName</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">commandType</span> <span class="p">=</span> <span class="n">commands</span><span class="p">.</span><span class="n">First</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">instance</span> <span class="p">=</span> <span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">prop</span> <span class="k">in</span> <span class="n">instance</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetProperties</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">attribute</span> <span class="p">=</span> <span class="n">prop</span><span class="p">.</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandOptionsValueAttribute</span><span class="p">&gt;();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">attribute</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">SetPropertyValue</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">attribute</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="n">SetPropertyValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">CommandLineParsedArgs</span> <span class="n">args</span><span class="p">,</span> <span class="n">T</span> <span class="n">instance</span><span class="p">,</span> <span class="n">PropertyInfo</span> <span class="n">prop</span><span class="p">,</span> <span class="n">CommandOptionsValueAttribute</span> <span class="n">attribute</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">arg</span> <span class="p">=</span> <span class="n">args</span>
                <span class="p">.</span><span class="n">CommandOptionsValues</span>
                <span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span>
                    <span class="n">x</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="n">attribute</span><span class="p">.</span><span class="n">Name</span> <span class="p">||</span>
                    <span class="n">x</span><span class="p">.</span><span class="n">Key</span> <span class="p">==</span> <span class="n">attribute</span><span class="p">.</span><span class="n">Alias</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">IsDefault</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">attribute</span><span class="p">.</span><span class="n">Required</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RequiredOptionNotFoundException</span><span class="p">(</span><span class="n">attribute</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">IsDefault</span><span class="p">()</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
            <span class="n">prop</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ChangeType</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">prop</span><span class="p">.</span><span class="n">PropertyType</span><span class="p">));</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">attribute</span><span class="p">.</span><span class="n">DefaultValue</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="n">prop</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ChangeType</span><span class="p">(</span><span class="n">attribute</span><span class="p">.</span><span class="n">DefaultValue</span><span class="p">,</span> <span class="n">prop</span><span class="p">.</span><span class="n">PropertyType</span><span class="p">));</span>
        <span class="k">else</span>
            <span class="n">prop</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ChangeType</span><span class="p">(</span><span class="n">prop</span><span class="p">.</span><span class="n">PropertyType</span><span class="p">.</span><span class="n">GetDefaultValue</span><span class="p">(),</span> <span class="n">prop</span><span class="p">.</span><span class="n">PropertyType</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="n">Type</span><span class="p">[]</span> <span class="nf">FindCommand</span><span class="p">(</span><span class="n">CommandLineParsedArgs</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">AssemblyFinder</span>
               <span class="p">.</span><span class="n">GetCurrentAssemblyWithDependencies</span><span class="p">()</span>
               <span class="p">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">GetTypes</span><span class="p">()</span>
                   <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">z</span> <span class="p">=&gt;</span> <span class="n">z</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">().</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandAttribute</span><span class="p">&gt;()</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span>
                   <span class="p">(</span><span class="n">z</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">().</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandAttribute</span><span class="p">&gt;().</span><span class="n">Name</span> <span class="p">==</span> <span class="n">args</span><span class="p">.</span><span class="n">CommandName</span> <span class="p">||</span>
                    <span class="n">z</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">().</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandAttribute</span><span class="p">&gt;().</span><span class="n">Alias</span> <span class="p">==</span> <span class="n">args</span><span class="p">.</span><span class="n">CommandName</span>
                   <span class="p">))).</span><span class="n">ToArray</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Wiem, że jest to refleksja w wersji hard, ale spełnia swoje zadanie i mapuje sparsowane argumenty na instancje klasy komendy. Całe rozwiązanie składa w całość CommandLineApplication:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">CommandLineApplication</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ICommandResolver</span> <span class="n">_resolver</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">TextWriter</span> <span class="n">_out</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">CommandLineApplication</span><span class="p">(</span><span class="n">ICommandResolver</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">TextWriter</span> <span class="n">@out</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_resolver</span> <span class="p">=</span> <span class="n">resolver</span><span class="p">;</span>
        <span class="n">_out</span> <span class="p">=</span> <span class="n">@out</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Run</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">parser</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CommandLineArgsParser</span><span class="p">(</span><span class="s">&quot;--&quot;</span><span class="p">,</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="sc">&#39;=&#39;</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span> <span class="p">},</span> <span class="m">0</span><span class="p">);</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">parsedArgs</span> <span class="p">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">handler</span> <span class="p">=</span> <span class="n">_resolver</span><span class="p">.</span><span class="n">ResolveCommandHandler</span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">handler</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">handler</span><span class="p">.</span><span class="n">ExecuteFromParsedArgs</span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">,</span> <span class="n">_out</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">help</span> <span class="p">=</span> <span class="n">_resolver</span><span class="p">.</span><span class="n">ResolveCommandHandler</span><span class="p">&lt;</span><span class="n">HelpCommandHandler</span><span class="p">&gt;(</span><span class="s">&quot;help&quot;</span><span class="p">);</span>
            <span class="n">help</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="k">new</span> <span class="n">HelpCommand</span> <span class="p">{</span> <span class="n">ErrorMessage</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="n">Message</span> <span class="p">},</span> <span class="n">_out</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>I to w sumie na tyle z podstawowego frameworka. Przejdziemy teraz do resolvera. Jest to w podstawowym wydaniu interfejs, ponieważ nie chciałem wiązać się silnie z żadną bibliotekę do dependeny injection. Wygląda on tak:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">interface</span> <span class="n">ICommandResolver</span>
<span class="p">{</span>
    <span class="n">IConsoleCommandHandler</span> <span class="nf">ResolveCommandHandler</span><span class="p">(</span><span class="n">CommandLineParsedArgs</span> <span class="n">args</span><span class="p">);</span>
    <span class="n">T</span> <span class="n">ResolveCommandHandler</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>Pierwsza metoda rozwiązuje handler jako interfejs co pozwoli mi go potem wywołać za pomocą sparsowanych elementów. Druga funkcja powinna zwrócić konkretny handler. Na powyższym przykładzie używam tego do wyświetlania helpa, więc się przydaje. W sowim rozwiązaniu zaimplementowałem handler przy użyciu Autofa,c ale można użyć dowolnego innego kontenera. Kod relovera jest prosty i wygląda tak:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">AutofacCommandResolver</span> <span class="p">:</span> <span class="n">ICommandResolver</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IContainer</span> <span class="n">_container</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">AutofacCommandResolver</span><span class="p">(</span><span class="n">IContainer</span> <span class="n">container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">IConsoleCommandHandler</span> <span class="nf">ResolveCommandHandler</span><span class="p">(</span><span class="n">CommandLineParsedArgs</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">commandName</span> <span class="p">=</span> <span class="n">GetQualifiedCommandName</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">CommandName</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">commandType</span> <span class="p">=</span> <span class="n">GetCommandType</span><span class="p">(</span><span class="n">commandName</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">_container</span><span class="p">.</span><span class="n">ResolveNamed</span><span class="p">(</span><span class="n">commandName</span><span class="p">,</span> <span class="n">commandType</span><span class="p">)</span> <span class="k">as</span> <span class="n">IConsoleCommandHandler</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">CommandNotFoundException</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">CommandName</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="k">public</span> <span class="n">T</span> <span class="n">ResolveCommandHandler</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_container</span><span class="p">.</span><span class="n">ResolveNamed</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="kt">string</span> <span class="nf">GetQualifiedCommandName</span><span class="p">(</span><span class="kt">string</span> <span class="n">commandName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">commandType</span> <span class="p">=</span> <span class="n">AssemblyFinder</span>
            <span class="p">.</span><span class="n">GetCurrentAssemblyWithDependencies</span><span class="p">()</span>
            <span class="p">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">GetTypes</span><span class="p">()</span>
                <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">().</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandAttribute</span><span class="p">&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">))</span>
            <span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span>
                <span class="n">x</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">().</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandAttribute</span><span class="p">&gt;().</span><span class="n">Name</span> <span class="p">==</span> <span class="n">commandName</span> <span class="p">||</span>
                <span class="n">x</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">().</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandAttribute</span><span class="p">&gt;().</span><span class="n">Alias</span> <span class="p">==</span> <span class="n">commandName</span>
            <span class="p">);</span>

        <span class="kt">string</span> <span class="n">retName</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">commandType</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="n">retName</span> <span class="p">=</span> <span class="n">commandType</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">().</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandAttribute</span><span class="p">&gt;().</span><span class="n">Name</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">retName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="n">Type</span> <span class="nf">GetCommandType</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">AssemblyFinder</span><span class="p">.</span><span class="n">GetCurrentAssemblyWithDependencies</span><span class="p">()</span>
             <span class="p">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">GetTypes</span><span class="p">()</span>
                 <span class="p">.</span><span class="n">Where</span><span class="p">(</span>
                    <span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">().</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandHandlerAttribute</span><span class="p">&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">))</span>
             <span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">()</span>
                     <span class="p">.</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandHandlerAttribute</span><span class="p">&gt;().</span><span class="n">CommandName</span> <span class="p">==</span> <span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Na koniec najważniejszy element, czyli automatyczna rejestracja handlerów zaimplementowana jako rozszerzenie do ContainerBuildera:</p>
<div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">CommandLineAutofacExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">RegisterConsoleCommands</span><span class="p">(</span><span class="k">this</span> <span class="n">ContainerBuilder</span> <span class="n">containerBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Type</span><span class="p">[]</span> <span class="n">commandsToRegister</span> <span class="p">=</span> <span class="n">AssemblyFinder</span>
            <span class="p">.</span><span class="n">GetCurrentAssemblyWithDependencies</span><span class="p">()</span>
            <span class="p">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">GetTypes</span><span class="p">()</span>
                <span class="p">.</span><span class="n">Where</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="n">t</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">()</span>
                    <span class="p">.</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandHandlerAttribute</span><span class="p">&gt;()</span> <span class="p">!=</span> <span class="k">null</span><span class="p">))</span>
            <span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">command</span> <span class="k">in</span> <span class="n">commandsToRegister</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">commandAttribute</span> <span class="p">=</span> <span class="n">command</span><span class="p">.</span><span class="n">GetTypeInfo</span><span class="p">().</span><span class="n">GetCustomAttribute</span><span class="p">&lt;</span><span class="n">CommandHandlerAttribute</span><span class="p">&gt;();</span>
            <span class="n">containerBuilder</span><span class="p">.</span><span class="n">RegisterType</span><span class="p">(</span><span class="n">command</span><span class="p">).</span><span class="n">Named</span><span class="p">(</span><span class="n">commandAttribute</span><span class="p">.</span><span class="n">CommandName</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>I to już tyle. Dzięki tym elementom jestem w stanie za pomocą dodania kolejnych dll sterować tym jakie komendy ma aplikacja, ponieważ dzięki assembly finder, który omawiałem w <a href="https://harunx9.github.io/automatyczna-rejestracja-zaleznosci-w-autofac-na-netcore.html#automatyczna-rejestracja-zaleznosci-w-autofac-na-netcore">tym</a> rejestruje to co znajdzie się w folderze z aplikacją. Jak uda mi się dokończyć texture packera to pokażę jak działa całość w akcji a pewnie przy okazji dokonam poprawek, błędów niezauważonych na etapie pisania/tworzenia podstawy. Zastanawiam się również nad przeniesieniem tego do biblioteki .NET Standard, ale to dopiero jak będę miał napisane na tym ze dwie wyszczególnione w poprzednim artykule aplikacje. A wy co o tym myślcie? Czy takie podejście ma sens i może być wykorzystywane?  Czy macie może jakieś inne rozwiązania?</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://harunx9.github.io/tag/blog.html">blog</a>
      <a href="https://harunx9.github.io/tag/net.html">.net</a>
      <a href="https://harunx9.github.io/tag/programming.html">programming</a>
      <a href="https://harunx9.github.io/tag/c.html">c#</a>
      <a href="https://harunx9.github.io/tag/netcore.html">.netcore</a>
      <a href="https://harunx9.github.io/tag/cli.html">cli</a>
    </p>
  </div>



    <div class="addthis_relatedposts_inline">


<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'programmingwarfare';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Programming warfare ",
  "url" : "https://harunx9.github.io",
  "image": "/images/avatar.jpg",
  "description": ""
}
</script>

</body>
</html>