
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="https://harunx9.github.io/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://harunx9.github.io/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://harunx9.github.io/theme/font-awesome/css/font-awesome.min.css">


    <link href="https://harunx9.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Programming warfare Atom">

    <link href="https://harunx9.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Programming warfare RSS">


<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-85776912-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<meta name="author" content="Szymon Wanot" />
<meta name="description" content="W poprzednich postach opisałem składowe potrzebne do napisania właściwego renderowania, dziś zajmiemy się właśnie Spritebatchem, który będzie służył w silniku 2DXngine do renderowania 2D. Zacznijmy jak zawsze od interfejsu klasy, którą będziemy omawiać: enum FlipEffect { NONE_FLIP, FLIP_HORIZONTAL, FLIP_VERTICAL, }; enum SortMode { NONE_SORT, FRONT_TO_BACK, BACK_TO_FRONT, }; class SpriteBatch { public: SpriteBatch(GraphicDevice* device); ~SpriteBatch …" />
<meta name="keywords" content="Gamedev, OpenGL">

<meta property="og:site_name" content="Programming warfare"/>
<meta property="og:title" content="Renderowanie 2D część 4.1: Spritebatch"/>
<meta property="og:description" content="W poprzednich postach opisałem składowe potrzebne do napisania właściwego renderowania, dziś zajmiemy się właśnie Spritebatchem, który będzie służył w silniku 2DXngine do renderowania 2D. Zacznijmy jak zawsze od interfejsu klasy, którą będziemy omawiać: enum FlipEffect { NONE_FLIP, FLIP_HORIZONTAL, FLIP_VERTICAL, }; enum SortMode { NONE_SORT, FRONT_TO_BACK, BACK_TO_FRONT, }; class SpriteBatch { public: SpriteBatch(GraphicDevice* device); ~SpriteBatch …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://harunx9.github.io/renderowanie-2d-czesc-41-spritebatch.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-06-18 17:00:00+02:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://harunx9.github.io/author/szymon-wanot.html">
<meta property="article:section" content="OpenGL"/>
<meta property="article:tag" content="Gamedev"/>
<meta property="article:tag" content="OpenGL"/>
<meta property="og:image" content="/images/avatar.jpg">

  <title>Programming warfare &ndash; Renderowanie 2D część 4.1: Spritebatch</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://harunx9.github.io">
        <img src="/images/avatar.jpg" alt="" title="">
      </a>
      <h1><a href="https://harunx9.github.io"></a></h1>


      <nav>
        <ul class="list">
          <li><a href="https://harunx9.github.io/pages/o-mnie.html#o-mnie">O mnie</a></li>

        </ul>
      </nav>

      <ul class="social">
        <li><a class="sc-github" href="https://github.com/Harunx9" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-linkedin" href="https://pl.linkedin.com/in/szymon-wanot-b0a146ab" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-twitter" href="https://twitter.com/szwanot" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/szymon.wanot" target="_blank"><i class="fa fa-facebook"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="renderowanie-2d-czesc-41-spritebatch">Renderowanie 2D część 4.1: Spritebatch</h1>
    <p>
          Posted on Sun 18 June 2017 in <a href="https://harunx9.github.io/category/opengl.html">OpenGL</a>


    </p>
  </header>


  <div>
    <p>W poprzednich postach opisałem składowe potrzebne do napisania właściwego renderowania, dziś zajmiemy się właśnie Spritebatchem, który będzie służył w silniku 2DXngine do renderowania 2D. Zacznijmy jak zawsze od  interfejsu klasy, którą będziemy omawiać:</p>
<div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">FlipEffect</span>
<span class="p">{</span>
    <span class="n">NONE_FLIP</span><span class="p">,</span>
    <span class="n">FLIP_HORIZONTAL</span><span class="p">,</span>
    <span class="n">FLIP_VERTICAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">SortMode</span>
<span class="p">{</span>
    <span class="n">NONE_SORT</span><span class="p">,</span>
    <span class="n">FRONT_TO_BACK</span><span class="p">,</span>
    <span class="n">BACK_TO_FRONT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">SpriteBatch</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">SpriteBatch</span><span class="p">(</span><span class="n">GraphicDevice</span><span class="o">*</span> <span class="n">device</span><span class="p">);</span>
    <span class="o">~</span><span class="n">SpriteBatch</span><span class="p">();</span>

    <span class="kt">bool</span> <span class="nf">initialize</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">set_renderTarget</span><span class="p">(</span><span class="n">RenderTarget</span><span class="o">*</span> <span class="n">target</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">begin</span><span class="p">();</span>
    <span class="kt">void</span> <span class="nf">begin</span><span class="p">(</span><span class="n">TextureWrap</span> <span class="n">wrap</span><span class="p">,</span> <span class="n">TextureFilter</span> <span class="n">filter</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">begin</span><span class="p">(</span><span class="n">ShaderProgram</span> <span class="o">*</span> <span class="n">shader</span><span class="p">,</span> <span class="n">TextureWrap</span> <span class="n">wrap</span><span class="p">,</span> <span class="n">TextureFilter</span> <span class="n">filter</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">mat4</span> <span class="n">viewportTransform</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">end</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">draw</span><span class="p">(</span><span class="n">Texture</span><span class="o">*</span> <span class="n">texture</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">position</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="kt">float</span> <span class="n">drawOrder</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">draw</span><span class="p">(</span><span class="n">Texture</span><span class="o">*</span> <span class="n">texture</span><span class="p">,</span> <span class="n">RectangleI</span> <span class="n">destinationRectangle</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="kt">float</span> <span class="n">drawOrder</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">draw</span><span class="p">(</span><span class="n">Texture</span><span class="o">*</span> <span class="n">texture</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">position</span><span class="p">,</span> <span class="n">RectangleI</span><span class="o">*</span> <span class="n">sourceRectangle</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="kt">float</span> <span class="n">drawOrder</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">draw</span><span class="p">(</span><span class="n">Texture</span><span class="o">*</span> <span class="n">texture</span><span class="p">,</span> <span class="n">RectangleI</span> <span class="n">destinationRectangle</span><span class="p">,</span> <span class="n">RectangleI</span><span class="o">*</span> <span class="n">sourceRectangle</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="kt">float</span> <span class="n">drawOrder</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">draw</span><span class="p">(</span><span class="n">Texture</span><span class="o">*</span> <span class="n">texture</span><span class="p">,</span> <span class="n">RectangleI</span> <span class="n">destinationRectangle</span><span class="p">,</span> <span class="n">RectangleI</span><span class="o">*</span> <span class="n">sourceRectangle</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="kt">float</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">origin</span><span class="p">,</span> <span class="n">FlipEffect</span> <span class="n">flip</span><span class="p">,</span> <span class="kt">float</span> <span class="n">drawOrder</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">draw</span><span class="p">(</span><span class="n">Texture</span><span class="o">*</span> <span class="n">texture</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">position</span><span class="p">,</span> <span class="n">RectangleI</span><span class="o">*</span> <span class="n">sourceRectangle</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="kt">float</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">origin</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">scale</span><span class="p">,</span> <span class="n">FlipEffect</span> <span class="n">flip</span><span class="p">,</span> <span class="kt">float</span> <span class="n">drawOrder</span><span class="p">);</span>
    <span class="kt">void</span> <span class="nf">draw</span><span class="p">(</span><span class="n">Texture</span><span class="o">*</span> <span class="n">texture</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">position</span><span class="p">,</span> <span class="n">RectangleI</span><span class="o">*</span> <span class="n">sourceRectangle</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="kt">float</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">origin</span><span class="p">,</span> <span class="kt">float</span> <span class="n">scale</span><span class="p">,</span> <span class="n">FlipEffect</span> <span class="n">flip</span><span class="p">,</span> <span class="kt">float</span> <span class="n">drawOrder</span><span class="p">);</span>

<span class="k">private</span><span class="o">:</span>
    <span class="k">struct</span> <span class="n">SpriteBatchItem</span>
    <span class="p">{</span>
        <span class="n">Texture</span> <span class="o">*</span> <span class="n">texture</span><span class="p">;</span>
        <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">postions</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">texcoords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
        <span class="n">glm</span><span class="o">::</span><span class="n">vec4</span> <span class="n">color</span><span class="p">;</span>
        <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">origin</span><span class="p">;</span>
        <span class="n">GLfloat</span> <span class="n">rot</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">drawOrder</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kt">void</span> <span class="nf">drawBatch</span><span class="p">();</span>

    <span class="kt">void</span> <span class="nf">clearBatchItems</span><span class="p">();</span>
    <span class="n">SpriteBatchItem</span> <span class="o">*</span> <span class="nf">createNewItem</span><span class="p">();</span>

    <span class="n">glm</span><span class="o">::</span><span class="n">mat4</span> <span class="n">_viewport</span><span class="p">;</span>
    <span class="n">glm</span><span class="o">::</span><span class="n">mat4</span> <span class="n">_viewportTransform</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="nf">initializeDefaultShader</span><span class="p">();</span>
    <span class="kt">bool</span> <span class="nf">isRenderTargetSet</span><span class="p">();</span>
    <span class="kt">size_t</span> <span class="n">_currentSpriteCount</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">SpriteBatchItem</span><span class="o">*&gt;</span>  <span class="n">_items</span><span class="p">;</span>
    <span class="n">RenderTarget</span> <span class="o">*</span> <span class="n">_currentTarget</span><span class="p">;</span>
    <span class="n">ShaderProgram</span> <span class="o">*</span> <span class="n">_defaultShader</span><span class="p">;</span>
    <span class="n">ShaderProgram</span> <span class="o">*</span> <span class="n">_customShader</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">_isInitialized</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">_isStarted</span><span class="p">;</span>
    <span class="n">SortMode</span> <span class="n">_sortMode</span><span class="p">;</span>
    <span class="n">SamplerState</span><span class="o">*</span> <span class="n">_sampler</span><span class="p">;</span>
    <span class="n">GLuint</span> <span class="n">_vao</span><span class="p">;</span>
    <span class="n">GLuint</span> <span class="n">_vbo</span><span class="p">;</span>
    <span class="n">GLuint</span> <span class="n">_ebo</span><span class="p">;</span>
    <span class="n">GraphicDevice</span><span class="o">*</span> <span class="n">_device</span><span class="p">;</span>
    <span class="n">GLfloat</span> <span class="n">_vertexBuffer</span><span class="p">[</span><span class="n">MAX_BATCH_ITEMS</span> <span class="o">*</span> <span class="mi">32</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>


<p>Zacznijmy od GraphicDevice, który przyjmuje konstruktor spritebatch. Na razie jest to proste opakowanie na OpenGL z SDL, może w przyszłości rozwinę ten koncept, ale na razie taka implementacja mi wystarczy, więc tak zostanie. Dalej jest inicjalizacja, funkcje rozpoczynające i  kończące rysowanie. Jeżeli chodzi o samo rysowanie to jak widzimy funkcja draw ma sporo przeciążeń, więc powinno wystarczyć dla zastosowań prostego rysowania 2D, ale po kolei jak odbywa się rysowanie. Tak na prawdę prawdziwe rysowanie następuje podczas działania funkcji end. Kolejne  wywołania draw mają za zadanie dodanie nowego SpriteBatchItem do kolejki rysowania. Sam SpriteBatchItem  jest zbiorem pewnych danych, które potrzebne są do narysowania tekstury na ekranie. Przykładowa implementacja funkcji draw wygląda w następujący sposób:</p>
<div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">SpriteBatch</span><span class="o">::</span><span class="n">draw</span><span class="p">(</span><span class="n">Texture</span> <span class="o">*</span> <span class="n">texture</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">position</span><span class="p">,</span> <span class="n">RectangleI</span> <span class="o">*</span> <span class="n">sourceRectangle</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">,</span> <span class="kt">float</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">origin</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span> <span class="n">scale</span><span class="p">,</span> <span class="n">FlipEffect</span> <span class="n">flip</span><span class="p">,</span> <span class="kt">float</span>  <span class="n">drawOrder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">batchItem</span> <span class="o">=</span> <span class="n">createNewItem</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">batchItem</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span><span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_width</span><span class="p">(),</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_height</span><span class="p">())</span> <span class="o">*</span> <span class="n">scale</span><span class="p">;</span>

    <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texture</span> <span class="o">=</span> <span class="n">texture</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rotation</span> <span class="o">==</span> <span class="mf">0.f</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">postions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">postions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">postions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
            <span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">postions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
            <span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="kt">float</span> <span class="n">cosRot</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">cos</span><span class="p">(</span><span class="n">rotation</span><span class="p">);</span>
        <span class="kt">float</span> <span class="n">sinRot</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">sin</span><span class="p">(</span><span class="n">rotation</span><span class="p">);</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">postions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">cosRot</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">sinRot</span><span class="p">),</span>
            <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">sinRot</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">cosRot</span><span class="p">));</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">postions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">cosRot</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span> <span class="n">sinRot</span><span class="p">,</span>
            <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">sinRot</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span> <span class="n">cosRot</span><span class="p">);</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">postions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">cosRot</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span> <span class="n">sinRot</span><span class="p">,</span>
            <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">sinRot</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span> <span class="n">cosRot</span><span class="p">);</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">postions</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="n">position</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">cosRot</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span> <span class="n">sinRot</span><span class="p">,</span>
            <span class="n">position</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">sinRot</span> <span class="o">-</span> <span class="p">(</span><span class="o">-</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">size</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span> <span class="n">cosRot</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//set color</span>
    <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">color</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
    <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">color</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
    <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">color</span><span class="p">.</span><span class="n">b</span><span class="p">;</span>
    <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">color</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>

    <span class="c1">//origin</span>
    <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">origin</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>

    <span class="c1">//rotation</span>
    <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">rot</span> <span class="o">=</span> <span class="mf">0.f</span><span class="p">;</span>

    <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">drawOrder</span> <span class="o">=</span> <span class="n">drawOrder</span><span class="p">;</span>

    <span class="c1">//texCoord</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sourceRectangle</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_x</span><span class="p">()</span> <span class="o">*</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_texelWidth</span><span class="p">(),</span>
            <span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_y</span><span class="p">()</span> <span class="o">*</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_texelHeight</span><span class="p">());</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="p">(</span><span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_width</span><span class="p">())</span> <span class="o">*</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_texelWidth</span><span class="p">(),</span>
            <span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_y</span><span class="p">()</span> <span class="o">*</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_texelHeight</span><span class="p">());</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_x</span><span class="p">()</span> <span class="o">*</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_texelWidth</span><span class="p">(),</span>
            <span class="p">(</span><span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_y</span><span class="p">()</span> <span class="o">+</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_height</span><span class="p">())</span> <span class="o">*</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_texelHeight</span><span class="p">());</span>

        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span>
            <span class="p">(</span><span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_width</span><span class="p">())</span> <span class="o">*</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_texelWidth</span><span class="p">(),</span>
            <span class="p">(</span><span class="n">sourceRectangle</span><span class="o">-&gt;</span><span class="n">get_y</span><span class="p">()</span> <span class="o">+</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_height</span><span class="p">())</span> <span class="o">*</span> <span class="n">texture</span><span class="o">-&gt;</span><span class="n">get_bitmap</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_texelHeight</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">0.f</span><span class="p">);</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span><span class="mf">0.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec2</span><span class="p">(</span><span class="mf">1.f</span><span class="p">,</span> <span class="mf">1.f</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">flip</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nl">FLIP_HORIZONTAL</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">tltmp1</span> <span class="o">=</span> <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">auto</span> <span class="n">trtmp</span> <span class="o">=</span> <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tltmp1</span><span class="p">;</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">trtmp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">FLIP_VERTICAL</span><span class="p">:</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">tltmp2</span> <span class="o">=</span> <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">auto</span> <span class="n">bltmp</span> <span class="o">=</span> <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tltmp2</span><span class="p">;</span>
        <span class="n">batchItem</span><span class="o">-&gt;</span><span class="n">texcoords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">bltmp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Za przykład wziąłem najbardziej rozbudowaną implementacje, żeby dokładnie prześledzić, to w jaki sposób potrzebujemy zapisać dane, aby potem mogły one zostać wyświetlone. Na początku tworzymy nowy SpritebatchItem, a nastepnie określamy wymiray tekstury przy zeskalowaniu. Kolejnym krokiem jest przypisanie wskaźnika na teksturę, jest to potrzebne, by potem pobrać z niego id tekstury.  Następnie w zależności od tego czy nasza tekstura jest obrócona czy nie, musimy przypisać pozycje do 4 vertexów w taki sposób:</p>
<div class="highlight"><pre><span></span><span class="k">[ tl ]---------[ tr ]</span>
  <span class="na">|             / |</span>
  <span class="na">|          /    |</span>
  <span class="na">|        /      |</span>
  <span class="na">|      /        |</span>
  <span class="na">|   /           |</span>
<span class="k">[ bl ]--------[ br ]</span>
</pre></div>


<p>Jak widać na schemacie każda tekstura składa się z połączonych 2 trójkątów, więc na logikę vertexów powinno być 6. Każdy vertex to jednak alokacja pamięci, więc tworzymy 4 vertexy i 6 indexów, czyli wskaźników na vertex. Dzięki temu unikamy dodatkowej alokacji pamięci, a efekt jest ten sam. W kolejnych krokach przypisane zostają kolor, origin (środek obiektu) oraz rotacja. Kolejną sprawą jest przypisanie koordynatów tekstury. Ostatnim etapem jest ewentualne odwrócenie tekstury, jeżeli jest ona w jakiś sposób odwrócona. Mniej więcej inne przeciążenia robią to samo. To w tej części na tyle, w następnym artykule prześledzimy jak wygląda samo rysowanie i jak używać naszego SpriteBatcha.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://harunx9.github.io/tag/gamedev.html">Gamedev</a>
      <a href="https://harunx9.github.io/tag/opengl.html">OpenGL</a>
    </p>
  </div>



    <div class="addthis_relatedposts_inline">


<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'programmingwarfare';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Programming warfare ",
  "url" : "https://harunx9.github.io",
  "image": "/images/avatar.jpg",
  "description": ""
}
</script>

</body>
</html>